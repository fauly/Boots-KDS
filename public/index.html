<script>
    document.addEventListener('DOMContentLoaded', function () {
        const container = document.getElementById('ordersContainer');
        const fetchRateSlider = document.getElementById('fetchRateSlider');
        const rateDisplay = document.getElementById('rateDisplay');
        let fetchInterval = parseInt(fetchRateSlider.value) * 1000;
    
        function getColorByElapsedTime(minutes) {
            let red, green;
            if (minutes <= 2) {
                red = Math.floor(255 * (minutes / 2));
                green = 255;
            } else {
                red = 255;
                green = Math.max(0, 255 - Math.floor(255 * ((minutes - 2) / 2)));
            }
            return `rgb(${red}, ${green}, 0)`;
        }
    
        function fetchOrders() {
            fetch('/api/getOrders')
                .then(response => response.json())
                .then(orders => {
                    container.innerHTML = ''; // Clear current orders
                    orders.reverse().slice(0, 12).forEach(order => {
                        const elapsedMinutes = (new Date() - new Date(order.created_at)) / 60000;
                        const color = getColorByElapsedTime(elapsedMinutes);
    
                        const orderDiv = document.createElement('div');
                        orderDiv.classList.add('order');
                        orderDiv.style.backgroundColor = color;
    
                        const table = document.createElement('table');
                        let tableContent = `<tr><th>Qty</th><th>Item</th></tr>`;
                        order.line_items.forEach(item => {
                            tableContent += `<tr><td>${item.quantity}</td><td>${item.name}${item.note ? `<br>- Note: ${item.note}` : ''}</td></tr>`;
                            if (item.modifiers && item.modifiers.length > 0) {
                                item.modifiers.forEach(mod => {
                                    tableContent += `<tr><td></td><td>- ${mod.name}</td></tr>`;
                                });
                            }
                        });
                        table.innerHTML = tableContent;
    
                        orderDiv.innerHTML = `
                            <strong>${order.given_name}</strong>
                            ${new Date(order.created_at).toLocaleTimeString()}<br>
                        `;
                        orderDiv.appendChild(table);
                        const button = document.createElement('button');
                        button.onclick = function() { markComplete(order.order_id); };
                        button.innerText = 'Mark Complete';
                        orderDiv.appendChild(button);
                        container.appendChild(orderDiv);
                    });
                })
                .catch(error => console.error('Error fetching orders:', error));
        }
    
        function markComplete(orderId) {
            fetch('/api/markComplete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ orderId })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Order marked as complete:', data);
                fetchOrders(); // Refresh the list
            })
            .catch(error => console.error('Error marking order complete:', error));
        }
    
        window.markComplete = markComplete; // Expose function to global scope
    
        let fetchTimer = setInterval(fetchOrders, fetchInterval);
    
        fetchRateSlider.oninput = function() {
            rateDisplay.textContent = this.value;
            fetchInterval = parseInt(this.value) * 1000;
            clearInterval(fetchTimer);
            fetchTimer = setInterval(fetchOrders, fetchInterval);
        };
    
        fetchOrders(); // Initial fetch
    });
    </script>